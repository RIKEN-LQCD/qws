name: CI

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  test-single:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: make with g++
        run: make -j 2 fugaku_benchmark= omp=1  compiler=gnu arch=skylake rdma= mpi= powerapi=
      - name: checking
        run: |
          ./main 32 6 4 3   1 1 1 1    -1   -1  6 50 > CASE0
          egrep ":  |2     ="  CASE0      | awk '{printf("%30s %30s\n", $1, $NF)}'> res1
          egrep ":  |2     ="  data/CASE0 | awk '{print $NF}'> res2
          paste res1 res2
  test-MPI:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: install openmpi
        run: sudo apt-get install openmpi-doc openmpi-bin libopenmpi-dev
      - name: make with mpic++(g++)
        run: make -j 2 fugaku_benchmark= omp=1  compiler=openmpi-gnu arch=skylake rdma= mpi=1 powerapi=

      # Runs a set of commands using the runners shell
      - name: make with MPI
        run: |
          echo $SHELL
          echo mpicc --version
          mpicc --version
          echo mpirun --version
          mpirun --version
